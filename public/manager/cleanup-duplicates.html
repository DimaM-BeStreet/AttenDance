<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×§×•×™ ×›×¤×™×œ×•×™×•×ª - AttenDance</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            padding: 40px 20px;
            background: #f5f5f5;
            direction: rtl;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #7c3aed;
            margin-bottom: 10px;
            font-size: 28px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #92400e;
        }
        button {
            background: #7c3aed;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px 10px 10px 0;
        }
        button:hover { background: #6d28d9; }
        button:disabled { 
            background: #ccc;
            cursor: not-allowed;
        }
        .danger { background: #ef4444; }
        .danger:hover { background: #dc2626; }
        #log {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            display: none;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        .stat {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #7c3aed;
            margin-bottom: 4px;
        }
        .stat-label {
            font-size: 13px;
            color: #666;
        }
        .duplicate-group {
            background: #fef2f2;
            border: 1px solid #fecaca;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .duplicate-group strong {
            color: #dc2626;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§¹ × ×™×§×•×™ ×›×¤×™×œ×•×™×•×ª ×ª×œ××™×“×™×</h1>
        <p class="subtitle">×›×œ×™ ×œ×–×™×”×•×™ ×•××—×™×§×ª ×ª×œ××™×“×™× ×›×¤×•×œ×™× ×¢×œ ×¤×™ ××¡×¤×¨ ×˜×œ×¤×•×Ÿ</p>
        
        <div class="warning">
            <strong>âš ï¸ ××–×”×¨×”:</strong> ×›×œ×™ ×–×” ×™××—×§ ×ª×œ××™×“×™× ×›×¤×•×œ×™× ×‘××•×¤×Ÿ ×§×‘×•×¢. 
            ×”×•× ×™×©××•×¨ ××ª ×”×ª×œ××™×“ ×”×•×•×ª×™×§ ×‘×™×•×ª×¨ ×• ×™××—×§ ××ª ×”×©××¨.
            ××•××œ×¥ ×œ×’×‘×•×ª ××ª ×”× ×ª×•× ×™× ×œ×¤× ×™ ×”××—×™×§×”.
        </div>

        <div class="stats" id="stats" style="display: none;"></div>
        
        <div id="duplicates" style="display: none; margin: 20px 0;"></div>

        <div>
            <button onclick="scanForDuplicates()" id="scanBtn">×¡×¨×•×§ ×›×¤×™×œ×•×™×•×ª</button>
            <button onclick="cleanupDuplicates()" id="cleanBtn" class="danger" style="display: none;">
                ××—×§ ×›×¤×™×œ×•×™×•×ª
            </button>
        </div>

        <div id="log"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, getDocs, deleteDoc, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase config (use your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyBl2z5oGH4VXm5qxWe8N1YF9ZEHvTv2Kxg",
            authDomain: "attendance-6e07e.firebaseapp.com",
            projectId: "attendance-6e07e",
            storageBucket: "attendance-6e07e.firebasestorage.app",
            messagingSenderId: "433536949748",
            appId: "1:433536949748:web:bc7cb6d0e6e7e7788e37bc"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.db = db;
        window.auth = auth;
        window.studioId = null;
        window.duplicateGroups = [];

        // Check authentication
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                alert('×× × ×”×ª×—×‘×¨ ×ª×—×™×œ×”');
                window.location.href = '/login.html';
                return;
            }

            // Get user's studio ID
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            const userData = userDoc.data();
            
            if (!userData || !['superAdmin', 'admin'].includes(userData.role)) {
                alert('××™×Ÿ ×œ×š ×”×¨×©××•×ª ×œ×“×£ ×–×”');
                window.location.href = '/';
                return;
            }

            window.studioId = userData.businessId;
            log(`âœ“ ××—×•×‘×¨ ×›-${userData.role}`);
            log(`âœ“ ×¡×˜×•×“×™×•: ${window.studioId}`);
        });

        window.log = function(message) {
            const logEl = document.getElementById('log');
            logEl.style.display = 'block';
            logEl.textContent += message + '\n';
            logEl.scrollTop = logEl.scrollHeight;
        }

        window.scanForDuplicates = async function() {
            if (!window.studioId) {
                alert('××™×Ÿ studio ID');
                return;
            }

            const scanBtn = document.getElementById('scanBtn');
            scanBtn.disabled = true;
            scanBtn.textContent = '×¡×•×¨×§...';
            document.getElementById('log').textContent = '';
            document.getElementById('log').style.display = 'block';

            log('××ª×—×™×œ ×¡×¨×™×§×ª ×›×¤×™×œ×•×™×•×ª...\n');

            try {
                const studentsRef = collection(db, `studios/${window.studioId}/students`);
                const snapshot = await getDocs(studentsRef);
                
                const students = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                log(`× ××¦××• ${students.length} ×ª×œ××™×“×™×\n`);

                // Group by phone
                const phoneGroups = {};
                students.forEach(student => {
                    if (!student.phone) return;
                    const normalizedPhone = student.phone.replace(/\D/g, '');
                    if (!phoneGroups[normalizedPhone]) {
                        phoneGroups[normalizedPhone] = [];
                    }
                    phoneGroups[normalizedPhone].push(student);
                });

                // Find duplicates
                const duplicates = Object.entries(phoneGroups)
                    .filter(([phone, students]) => students.length > 1)
                    .map(([phone, students]) => {
                        // Sort: keep oldest (first by importedAt, then by createdAt)
                        students.sort((a, b) => {
                            if (a.importedAt && !b.importedAt) return 1;
                            if (!a.importedAt && b.importedAt) return -1;
                            const aTime = a.createdAt?.toMillis?.() || 0;
                            const bTime = b.createdAt?.toMillis?.() || 0;
                            return aTime - bTime;
                        });
                        return { phone, students };
                    });

                window.duplicateGroups = duplicates;

                const totalDuplicates = duplicates.reduce((sum, g) => sum + (g.students.length - 1), 0);

                log(`\nğŸ“Š ×ª×•×¦××•×ª ×”×¡×¨×™×§×”:`);
                log(`   ×›×¤×™×œ×•×™×•×ª: ${duplicates.length} ××¡×¤×¨×™ ×˜×œ×¤×•×Ÿ`);
                log(`   ×ª×œ××™×“×™× ×œ××—×™×§×”: ${totalDuplicates}\n`);

                // Show stats
                document.getElementById('stats').style.display = 'grid';
                document.getElementById('stats').innerHTML = `
                    <div class="stat">
                        <div class="stat-number">${students.length}</div>
                        <div class="stat-label">×¡×”"×› ×ª×œ××™×“×™×</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${duplicates.length}</div>
                        <div class="stat-label">×˜×œ×¤×•× ×™× ×›×¤×•×œ×™×</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${totalDuplicates}</div>
                        <div class="stat-label">×œ××—×™×§×”</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number">${students.length - totalDuplicates}</div>
                        <div class="stat-label">×™×™×©××¨×•</div>
                    </div>
                `;

                // Show duplicate groups
                if (duplicates.length > 0) {
                    const dupContainer = document.getElementById('duplicates');
                    dupContainer.style.display = 'block';
                    dupContainer.innerHTML = '<h3 style="margin-bottom: 12px;">×§×‘×•×¦×•×ª ×›×¤×•×œ×™×:</h3>';
                    
                    duplicates.slice(0, 10).forEach(group => {
                        const div = document.createElement('div');
                        div.className = 'duplicate-group';
                        div.innerHTML = `
                            <strong>ğŸ“ ${group.phone}</strong> - ${group.students.length} ×ª×œ××™×“×™×<br>
                            ${group.students.map((s, i) => 
                                `${i === 0 ? 'âœ“' : 'âœ—'} ${s.firstName} ${s.lastName} (${s.importedAt ? '××™×•×‘×' : '××§×•×¨×™'})`
                            ).join('<br>')}
                        `;
                        dupContainer.appendChild(div);
                    });

                    if (duplicates.length > 10) {
                        dupContainer.innerHTML += `<p style="margin-top: 12px; color: #666;">×•×¢×•×“ ${duplicates.length - 10} ×§×‘×•×¦×•×ª...</p>`;
                    }

                    document.getElementById('cleanBtn').style.display = 'inline-block';
                } else {
                    log('\nâœ… ×œ× × ××¦××• ×›×¤×™×œ×•×™×•×ª!');
                }

            } catch (error) {
                log(`\nâŒ ×©×’×™××”: ${error.message}`);
                console.error(error);
            } finally {
                scanBtn.disabled = false;
                scanBtn.textContent = '×¡×¨×•×§ ×©×•×‘';
            }
        }

        window.cleanupDuplicates = async function() {
            if (window.duplicateGroups.length === 0) {
                alert('×œ× × ××¦××• ×›×¤×™×œ×•×™×•×ª');
                return;
            }

            const totalToDelete = window.duplicateGroups.reduce((sum, g) => sum + (g.students.length - 1), 0);
            
            if (!confirm(`×”×× ×œ××—×•×§ ${totalToDelete} ×ª×œ××™×“×™× ×›×¤×•×œ×™×?\n\n×–×” ×™××—×§ ×ª×œ××™×“×™× ×‘××•×¤×Ÿ ×§×‘×•×¢!`)) {
                return;
            }

            const cleanBtn = document.getElementById('cleanBtn');
            cleanBtn.disabled = true;
            cleanBtn.textContent = '××•×—×§...';

            log('\nğŸ—‘ï¸ ××ª×—×™×œ ××—×™×§×”...\n');

            let deleted = 0;
            let failed = 0;

            try {
                for (const group of window.duplicateGroups) {
                    // Skip first (keep it), delete the rest
                    for (let i = 1; i < group.students.length; i++) {
                        try {
                            await deleteDoc(doc(db, `studios/${window.studioId}/students`, group.students[i].id));
                            deleted++;
                            log(`âœ“ × ××—×§: ${group.students[i].firstName} ${group.students[i].lastName}`);
                        } catch (error) {
                            failed++;
                            log(`âœ— ×©×’×™××” ×‘××—×™×§×ª: ${group.students[i].firstName} ${group.students[i].lastName}`);
                        }
                    }
                }

                log(`\nâœ… ×”×•×©×œ×!`);
                log(`   × ××—×§×•: ${deleted}`);
                if (failed > 0) {
                    log(`   × ×›×©×œ×•: ${failed}`);
                }
                log(`\n×× × ×¨×¢× ×Ÿ ××ª ×“×£ ×”×ª×œ××™×“×™×.`);

                setTimeout(() => {
                    if (confirm('×”×× ×œ×—×–×•×¨ ×œ×“×£ ×”×ª×œ××™×“×™×?')) {
                        window.location.href = '/manager/students.html';
                    }
                }, 2000);

            } catch (error) {
                log(`\nâŒ ×©×’×™××” ×›×œ×œ×™×ª: ${error.message}`);
                console.error(error);
            } finally {
                cleanBtn.disabled = false;
                cleanBtn.textContent = '××—×§ ×›×¤×™×œ×•×™×•×ª';
            }
        }
    </script>
</body>
</html>
